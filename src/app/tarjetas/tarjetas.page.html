<ion-content class="cards-background">

  <div class="dashboard-header">

    <div class="header-top">
      <ion-title class="page-title">Gestión de Tarjetas</ion-title>
    </div>

    <div class="segment-wrapper">
      <ion-segment
        [(ngModel)]="currentView"
        (ionChange)="onViewChange($event)"
        mode="ios"
        class="custom-segment">

        <ion-segment-button value="active">
          <ion-label>Activas</ion-label>
        </ion-segment-button>

        <ion-segment-button value="deleted">
          <ion-label>Papelera</ion-label>
        </ion-segment-button>

      </ion-segment>
    </div>

  </div>

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <ion-list class="card-list" *ngIf="currentCards.length > 0">

    <ion-item-sliding *ngFor="let card of currentCards; trackBy: trackByCardId" class="sliding-card-wrapper">

      <ion-item lines="none" class="user-card">

        <div slot="start" class="card-icon-box" [class.deleted]="currentView === 'deleted'">
          <ion-icon [name]="currentView === 'deleted' ? 'trash-bin-outline' : 'card-outline'"></ion-icon>
        </div>

        <ion-label>
          <h2 class="card-name">{{ card.name }}</h2>
          <div class="card-details">
            <span class="uid-tag">
              <ion-icon name="finger-print-outline"></ion-icon> {{ card.uid }}
            </span>
            <span class="date-tag">
              {{ currentView === 'deleted' ? 'Eliminada:' : 'Registro:' }}
              {{ formatDate(currentView === 'deleted' ? card.deletedAt! : card.createdAt) }}
            </span>
          </div>
        </ion-label>

        <div slot="end">
          <ion-badge [color]="currentView === 'active' ? 'success' : 'medium'" class="status-badge">
            {{ currentView === 'active' ? 'ACTIVA' : 'ELIMINADA' }}
          </ion-badge>
        </div>

      </ion-item>

      <ion-item-options side="end" *ngIf="currentView === 'active'">
        <ion-item-option color="danger" (click)="deleteCard(card)">
          <ion-icon name="trash-outline" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>

      <ion-item-options side="start" *ngIf="currentView === 'deleted'">
        <ion-item-option color="success" (click)="restoreCard(card)">
          <ion-icon name="arrow-undo-outline" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>

      <ion-item-options side="end" *ngIf="currentView === 'deleted'">
        <ion-item-option color="danger" (click)="permanentDeleteCard(card)">
          <ion-icon name="close-circle-outline" slot="icon-only"></ion-icon>
        </ion-item-option>
      </ion-item-options>

    </ion-item-sliding>

  </ion-list>

  <div *ngIf="!isLoading && currentCards.length === 0" class="empty-state">
    <div class="empty-icon-circle">
      <ion-icon name="layers-outline"></ion-icon>
    </div>
    <h3>Lista Vacía</h3>
    <p *ngIf="currentView === 'active'">No hay tarjetas activas.</p>
    <p *ngIf="currentView === 'deleted'">La papelera está limpia.</p>
  </div>

  <ion-fab vertical="bottom" horizontal="end" slot="fixed" *ngIf="currentView === 'active' && isAdmin">
    <ion-fab-button (click)="openAddCardModal()" color="secondary" class="glow-fab">
      <ion-icon name="add"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-fab vertical="bottom" horizontal="start" slot="fixed" *ngIf="currentView === 'active'">
    <ion-fab-button [disabled]="isNfcScanning || !nfcAvailable" (click)="readNfcUid()" color="light" class="small-fab">
      <ion-spinner *ngIf="isNfcScanning" name="crescent"></ion-spinner>
      <ion-icon *ngIf="!isNfcScanning" name="scan-outline"></ion-icon>
    </ion-fab-button>
  </ion-fab>

  <ion-modal [isOpen]="isModalOpen" (willDismiss)="closeModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar color="primary">
          <ion-title>Nueva Tarjeta</ion-title>
          <ion-buttons slot="end">
            <ion-button (click)="closeModal()">
              <ion-icon name="close-circle-outline" slot="icon-only" color="light"></ion-icon>
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding modal-content-area">
        <div class="modal-intro">
          <p>Ingresa los datos del usuario.</p>
        </div>

        <ion-item class="modal-input" lines="none">
            <ion-icon name="card-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input [(ngModel)]="newCardName" label="Nombre" labelPlacement="floating"></ion-input>
        </ion-item>

        <ion-item class="modal-input" lines="none">
            <ion-icon name="finger-print-outline" slot="start" class="input-icon"></ion-icon>
            <ion-input [(ngModel)]="newCardUid" (ionInput)="validateUidInput($event)" label="UID" labelPlacement="floating"></ion-input>
        </ion-item>

        <div class="uid-feedback" *ngIf="newCardUid.length > 0">
           <ion-text [color]="uidValid ? 'success' : 'danger'">
             <ion-icon [name]="uidValid ? 'checkmark-circle' : 'close-circle'"></ion-icon>
             {{ uidValid ? 'Formato Válido' : 'Formato Inválido' }}
           </ion-text>
        </div>

        <ion-button expand="block" (click)="saveCard()" class="ion-margin-top modal-btn" [disabled]="!uidValid">
          GUARDAR TARJETA
        </ion-button>
      </ion-content>
    </ng-template>
  </ion-modal>

</ion-content>
