<ion-header class="ion-no-border">

  <div class="dashboard-header">

    <div class="header-top">
      <ion-title class="page-title">Bitácora S.A.V.E.</ion-title>
      <ion-button fill="clear" (click)="clearFilters()" [disabled]="!hasActiveFilters()" class="clear-btn">
        <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </div>

    <ion-searchbar
      mode="ios"
      placeholder="Buscar usuario o UID..."
      (ionInput)="handleSearch($event)"
      [value]="searchTerm"
      class="custom-searchbar">
    </ion-searchbar>

    <div class="filters-row">

      <div class="filter-chip">
        <ion-icon name="calendar-outline"></ion-icon>
        <ion-datetime-button datetime="date-filter"></ion-datetime-button>
      </div>

      <div class="filter-chip">
        <ion-icon name="filter-outline"></ion-icon>
        <ion-select
          interface="popover"
          [value]="filters.type"
          (ionChange)="handleTypeFilter($event)"
          placeholder="Tipo"
          toggleIcon="chevron-down-outline">
          <ion-select-option value="">Todos</ion-select-option>
          <ion-select-option value="RFID">Tarjeta</ion-select-option>
          <ion-select-option value="REMOTE">App</ion-select-option>
        </ion-select>
      </div>

      <ion-button (click)="onConsultarButton()" size="small" shape="round" color="secondary" class="action-btn">
        <ion-icon name="search" slot="icon-only"></ion-icon>
      </ion-button>

    </div>

  </div>
</ion-header>

<ion-content class="history-background">

  <ion-modal [keepContentsMounted]="true">
    <ng-template>
      <ion-datetime
        id="date-filter"
        presentation="date"
        [showDefaultButtons]="true"
        [value]="selectedDate"
        (ionChange)="handleDateFilter($event)"
        doneText="Aplicar"
        cancelText="Cancelar">
      </ion-datetime>
    </ng-template>
  </ion-modal>

  <ion-refresher slot="fixed" (ionRefresh)="doRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>

  <div *ngIf="errorMessage" class="error-banner">
    <ion-icon name="alert-circle"></ion-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <ion-list class="history-list" *ngIf="accessRecords.length > 0">

    <ion-item *ngFor="let record of accessRecords; trackBy: trackByRecordId"
              lines="none"
              class="history-card">

      <div slot="start" class="status-icon-box" [ngClass]="record.isAuthorized ? 'status-success' : 'status-danger'">
        <ion-icon [name]="getAccessIcon(record)"></ion-icon>
      </div>

      <ion-label>
        <h2 class="record-name">{{ record.cardName }}</h2>
        <div class="record-details">
          <span class="uid-tag">
            <ion-icon name="finger-print-outline"></ion-icon> {{ record.cardId }}
          </span>
          <span class="date-tag">
             {{ record.timestamp | date:'HH:mm' }} • {{ record.timestamp | date:'dd MMM' }}
          </span>
        </div>
      </ion-label>

      <div slot="end" class="badge-column">
        <ion-badge [color]="getAccessColor(record)" class="custom-badge">
          {{ record.isAuthorized ? 'AUTORIZADO' : 'DENEGADO' }}
        </ion-badge>
        <small class="origin-text">{{ getAccessBadgeText(record) }}</small>
      </div>

    </ion-item>
  </ion-list>

  <div *ngIf="!isLoading && accessRecords.length === 0" class="empty-state">
    <div class="empty-icon-circle">
      <ion-icon name="reader-outline"></ion-icon>
    </div>
    <h3>Sin Movimientos</h3>
    <p>No se encontraron registros con estos filtros.</p>
  </div>

  <ion-infinite-scroll [disabled]="!hasNextPage" (ionInfinite)="loadMore($event)">
    <ion-infinite-scroll-content loadingSpinner="crescent"></ion-infinite-scroll-content>
  </ion-infinite-scroll>

</ion-content>
